import React, { useState, useEffect, useRef } from 'react';
import { db } from '../../firebaseConfig/firebase'; // Ajusta la ruta según tu estructura de proyecto
import { collection, onSnapshot } from 'firebase/firestore';

// Diccionario con coordenadas relativas de cada lote por manzana
const coordenadasLotes = {
  1:{
    1:{x: 40.32258064516129, y: 563.2000122070312},
    2:{x: 45.6989247311828, y: 541.2000122070312},
    3:{x: 55.55555555555555, y: 559.2000122070312},
    4:{x: 59.13978494623656, y: 523.2000122070312},
    5:{x: 68.99641577060932, y: 537.2000122070312},
    6:{x: 70.78853046594982, y: 495.20001220703125},
    7:{x: 80.64516129032258, y: 505.20001220703125},
    8:{x: 84.2293906810036, y: 481.20001220703125},
    9:{x: 92.29390681003584, y: 501.20001220703125},
    10:{x: 96.77419354838709, y: 465.20001220703125},
    11: {x: 105.73476702508961, y: 485.20001220703125},
    12: {x: 110.21505376344086, y: 449.20001220703125},
    13: {x: 124.55197132616487, y: 467.20001220703125},
    14: {x: 123.65591397849462, y: 431.20001220703125},
    15: {x: 131.72043010752688, y: 449.20001220703125},
    16: {x: 132.61648745519713, y: 499.20001220703125},
    17: {x: 125.44802867383511, y: 521.2000122070312},
    18: {x: 117.38351254480287, y: 517.2000122070312},
    19: {x: 112.90322580645162, y: 539.2000122070312},
    20: {x: 103.04659498207886, y: 523.2000122070312},
    21: {x: 99.46236559139784, y: 553.2000122070312},
    22: {x: 91.3978494623656, y: 545.2000122070312},
    23: {x: 86.91756272401433, y: 571.2000122070312},
    24: {x: 75.26881720430107, y: 557.2000122070312},
    25: {x: 72.58064516129033, y: 587.2000122070312},
    26: {x: 64.51612903225806, y: 571.2000122070312},
    27: {x: 59.13978494623656, y: 599.2000122070312},
    28: {x: 49.2831541218638, y: 589.2000122070312},
    29: {x: 44.80286738351254, y: 619.2000122070312}
  },
  2:{
     1: {x: 51.075268817204304, y: 685.2000122070312},
    2: {x: 59.13978494623656, y: 683.2000122070312},
    3: {x: 64.51612903225806, y: 665.2000122070312},
     4: {x: 72.58064516129033, y: 661.2000122070312},
    5: {x: 78.85304659498208, y: 649.2000122070312},
    6: {x: 85.12544802867383, y: 639.2000122070312},
 7: {x: 92.29390681003584, y: 633.2000122070312},
 8: {x: 98.5663082437276, y: 623.2000122070312},
 9: {x: 105.73476702508961, y: 617.2000122070312},
 10: {x: 112.00716845878136, y: 607.2000122070312},
 11: {x: 119.17562724014337, y: 603.2000122070312},
 12: {x: 124.55197132616487, y: 593.2000122070312},
  13: {x: 134.40860215053763, y: 583.2000122070312},
  14: {x: 133.51254480286738, y: 653.2000122070312},
  15: {x: 127.24014336917564, y: 667.2000122070312},
  16 :{x: 119.17562724014337, y: 677.2000122070312},
  17 :{x: 112.90322580645162, y: 687.2000122070312},
  18 :{x: 105.73476702508961, y: 695.2000122070312},
  19 :{x: 98.5663082437276, y: 703.2000122070312},
  20 :{x: 92.29390681003584, y: 711.2000122070312},
  21 :{x: 85.12544802867383, y: 717.2000122070312},
  22 :{x: 77.95698924731182, y: 727.2000122070312},
  23 :{x: 71.68458781362007, y: 737.2000122070312},
  24 :{x: 64.51612903225806, y: 743.2000122070312},
  25 :{x: 57.34767025089606, y: 751.2000122070312}
  },
  3:{
    1: {x: 151.43369175627242, y: 445.20001220703125}, 
 2: {x: 160.3942652329749, y: 451.20001220703125}, 
 3: {x: 166.66666666666666, y: 455.20001220703125}, 
 4: {x: 173.83512544802866, y: 455.20001220703125}, 
 5: {x: 181.00358422939067, y: 455.20001220703125}, 
 6: {x: 188.17204301075267, y: 455.20001220703125}, 
 7: {x: 196.23655913978493, y: 455.20001220703125}, 
 8: {x: 203.40501792114696, y: 461.20001220703125}, 
 9: {x: 210.57347670250894, y: 465.20001220703125}, 
 10: {x: 216.8458781362007, y: 475.20001220703125}, 
 31: {x: 224.01433691756273, y: 479.20001220703125}, 
 32: {x: 230.28673835125448, y: 481.20001220703125}, 
 13: {x: 237.4551971326165, y: 485.20001220703125}, 
 34: {x: 245.51971326164875, y: 487.20001220703125}, 
 15: {x: 242.831541218638, y: 539.2000122070312}, 
 16: {x: 234.76702508960574, y: 533.2000122070312}, 
 17: {x: 229.39068100358423, y: 525.2000122070312}, 
 18: {x: 220.43010752688173, y: 531.2000122070312}, 
 19: {x: 213.2616487455197, y: 529.2000122070312}, 
 20: {x: 206.09318996415772, y: 527.2000122070312}, 
 21: {x: 199.82078853046596, y: 527.2000122070312}, 
 22: {x: 191.7562724014337, y: 523.2000122070312}, 
 23: {x: 184.58781362007167, y: 519.2000122070312}, 
 24: {x: 176.52329749103941, y: 515.2000122070312}, 
 35: {x: 170.25089605734766, y: 511.20001220703125}, 
 26: {x: 163.9784946236559, y: 509.20001220703125}, 
 27: {x: 157.70609318996415, y: 505.20001220703125}, 
 28: {x: 150.53763440860214, y: 493.20001220703125}

  },

  4: {
     1: {x: 155.0179211469534, y: 571.2000122070312}, 
     2: {x: 154.12186379928318, y: 601.2000122070312}, 
     3: {x: 166.66666666666666, y: 601.2000122070312},
     4: {x: 173.83512544802866, y: 607.2000122070312},   
        5: {x: 181.00358422939067, y: 599.2000122070312}, 
       6: {x: 189.06810035842295, y: 595.2000122070312}, 
      7: {x: 194.44444444444446, y: 603.2000122070312}, 
      8: {x: 201.61290322580643, y: 613.2000122070312},
         9: {x: 206.98924731182797, y: 615.2000122070312}, 
        10: {x: 214.15770609318997, y: 619.2000122070312},
     11: {x: 222.2222222222222, y: 621.2000122070312},      
     12: {x: 230.28673835125448, y: 619.2000122070312},
     13: {x: 236.55913978494624, y: 631.2000122070312},
     14: {x: 233.87096774193546, y: 679.2000122070312},
     15: {x: 226.70250896057348, y: 671.2000122070312},
     16: {x: 219.53405017921145, y: 679.2000122070312},
     17: {x: 212.36559139784947, y: 679.2000122070312},
     18: {x: 205.19713261648744, y: 667.2000122070312},
     19: {x: 197.1326164874552, y: 667.2000122070312},      
     20: {x: 190.86021505376343, y: 667.2000122070312},
     21: {x: 182.7956989247312, y: 663.2000122070312},      
     22: {x: 176.52329749103941, y: 661.2000122070312},
     23: {x: 171.14695340501794, y: 659.2000122070312},
     24: {x: 163.9784946236559, y: 653.2000122070312},      
     25: {x: 155.0179211469534, y: 639.2000122070312},    
  },
  5: {
    1: { x: 262.3333282470703, y: 470.2708282470703 },
    2: { x: 272.3333282470703, y: 473.2708282470703 },
    3: { x: 279.3333282470703, y: 476.2708282470703 },
    4: { x: 280.3333282470703, y: 475.2708282470703 },
    5: { x: 290.3333282470703, y: 473.2708282470703 },
    6: { x: 301.3333282470703, y: 478.2708282470703 },
    7: { x: 308.3333282470703, y: 477.2708282470703 },
    8: { x: 317.3333282470703, y: 470.2708282470703 },
    9: { x: 326.3333282470703, y: 478.2708282470703 },
    10: { x: 334.3333282470703, y: 489.2708282470703 },
    11: { x: 333.3333282470703, y: 480.2708282470703 },
    12: { x: 342.3333282470703, y: 480.2708282470703 },
    13: { x: 344.3333282470703, y: 540.2708282470703 },
    14: { x: 335.3333282470703, y: 540.2708282470703 },
    15: { x: 336.3333282470703, y: 540.2708282470703 },
    16: {  x: 328.3333282470703, y: 540.2708282470703 },
    17: { x: 319.3333282470703, y: 540.2708282470703 },
    18: { x: 309.3333282470703, y: 540.2708282470703 },
    19: { x: 300.3333282470703, y: 540.2708282470703 },
    20: { x: 292.3333282470703, y: 540.2708282470703 },
    21: { x: 285.3333282470703, y: 540.2708282470703 },
    22: { x: 284.3333282470703, y: 560.2708282470703 },
    23: { x: 275.3333282470703, y: 540.2708282470703 },
    24: { x: 268.3333282470703, y: 540.2708282470703 },
    25: { x: 260.3333282470703, y: 540.2708282470703 },
    // Agrega más lotes aquí
  },
  6: {
    1: { x: 252, y: 640 },
    2: { x: 262, y: 640 },
    3: { x: 272, y: 640 },
    4: { x: 272, y: 640 },
    5: { x: 285, y: 640 },
    6: { x: 295, y: 640 },
    7: { x: 302, y: 640 },
    8: { x: 312, y: 640 },
    9: { x: 317, y: 640 },
    10: { x: 325, y: 630 },
    11: { x: 330, y: 630 },
    12: { x: 335, y: 620 },
    13: { x: 342, y: 620 },
    14: { x: 345, y: 660 },
    15: { x: 342, y: 670 },
    16: { x: 335, y: 675 },
    17: { x: 325, y: 675 },
    18: { x: 320, y: 675 },
    19: { x: 310, y: 675 },
    20: { x: 305, y: 670 },
    21: { x: 298, y: 680 },
    22: { x: 290, y: 680 },
    23: { x: 285, y: 685 },
    24: { x: 280, y: 685 },
    25: { x: 270, y: 685 },
    26: { x: 260, y: 685 },
    27: { x: 255, y: 685 },
    // Agrega más lotes aquí
  },
  7: {
    1: { x: 362.3333282470703, y: 450.2708282470703 },
    2: { x: 362, y: 450 },
    3: { x: 372, y: 450 },
    4: { x: 378, y: 450 },
    5: { x: 385, y: 450 },
    6: { x: 395, y: 450 },
    7: { x: 399, y: 450 },
    8: { x: 402, y: 450 },
    9: { x: 412, y: 450 },
    10: { x: 420, y: 450 },
    11: { x: 425, y: 450 },
    
    14: { x: 440, y: 540 },
    15: { x: 432, y: 540 },
    16: { x: 425, y: 545 },
    17: { x: 415, y: 545 },
    18: { x: 410, y: 545 },
    19: { x: 410, y: 545 },
    20: { x: 405, y: 540 },
    21: { x: 398, y: 540 },
    22: { x: 385, y: 540 },
    23: { x: 380, y: 545 },
    24: { x: 370, y: 545 },
    25: { x: 360, y: 545 },
    // Agrega más lotes aquí
  },
  8:{
  1: {x: 362.00716845878134, y: 617.2000122070312},
  2: {x: 370.9677419354839, y: 619.2000122070312},   
  3: {x: 376.34408602150535, y: 613.2000122070312},
  4: {x: 383.5125448028674, y: 617.2000122070312},   
  5: {x: 391.57706093189967, y: 611.2000122070312},
  6: {x: 398.7455197132617, y: 597.2000122070312},   
  7: {x: 405.9139784946236, y: 597.2000122070312},   
  8: {x: 413.0824372759856, y: 613.2000122070312}, 
  9: {x: 419.35483870967744, y: 605.2000122070312},
  10: {x: 428.31541218637994, y: 609.2000122070312},
  11: {x: 436.37992831541214, y: 609.2000122070312},
  12: {x: 442.65232974910396, y: 611.2000122070312},
  13: {x: 448.9247311827957, y: 597.2000122070312},
  14: {x: 449.82078853046596, y: 611.2000122070312},
  15: {x: 450.7168458781362, y: 653.2000122070312},
  16: {x: 443.5483870967742, y: 663.2000122070312},
  17: {x: 435.48387096774195, y: 663.2000122070312},
  18: {x: 429.2114695340502, y: 671.2000122070312},
  19: {x: 422.0430107526882, y: 669.2000122070312},
  20: {x: 413.0824372759856, y: 673.2000122070312},
  21: {x: 406.8100358422939, y: 671.2000122070312},
  22: {x: 399.6415770609319, y: 677.2000122070312},
  23: {x: 391.57706093189967, y: 669.2000122070312},
  24: {x: 385.30465949820785, y: 679.2000122070312},
  25: {x: 378.1362007168459, y: 679.2000122070312},
  26: {x: 370.07168458781365, y: 683.2000122070312},
  27: {x: 363.79928315412184, y: 675.2000122070312}
  }
  // Agrega más manzanas aquí
};

export const MapaSeguridad2 = () => {
  const [unidades, setUnidades] = useState([ ]);
  const [selected, setSelected] = useState({ manzana: '', lote: '' });
  const canvasRef = useRef(null);
  const containerRef = useRef(null);

  useEffect(() => {
    const unsubscribe = onSnapshot(collection(db, 'mensajes'), (snapshot) => {
      snapshot.docChanges().forEach((change) => {
        if (change.type === 'added') {
          const newMessage = change.doc.data();
          const updatedUnidades = unidades.map((unidad) =>
            unidad.manzana === newMessage.manzana && unidad.lote === newMessage.lote
              ? { ...unidad, position: coordenadasLotes[newMessage.manzana]?.[newMessage.lote] || unidad.position }
              : unidad
          );
          setUnidades(updatedUnidades);
        }
      });
    });

    return () => unsubscribe();
  }, [unidades]);

  useEffect(() => {
    const canvas = canvasRef.current;
    const ctx = canvas.getContext('2d');

    const drawMap = () => {
      const img = new Image();
      img.src = '/img/planoIslas.png'; // Ruta de la imagen
      img.onload = () => {
        canvas.width = containerRef.current.offsetWidth;
        canvas.height = containerRef.current.offsetHeight;
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        unidades.forEach((unidad) => {
          const x = (unidad.position.x / 1000) * canvas.width;
          const y = (unidad.position.y / 1000) * canvas.height;
          ctx.beginPath();
          ctx.arc(x, y, 5, 0, 2 * Math.PI);
          ctx.fillStyle = 'red';
          ctx.fill();
          ctx.stroke();

          ctx.font = '12px Arial';
          ctx.fillStyle = 'black';
          ctx.fillText(`Manzana ${unidad.manzana} Lote ${unidad.lote}`, x + 12, y);
        });
      };
    };

    const handleClick = (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left; // Coordenada X relativa al canvas
        const y = e.clientY - rect.top;  // Coordenada Y relativa al canvas
        console.log(`Coordenadas del clic - x: ${x}, y: ${y}`);
        alert(`Coordenadas del clic - x: ${x}, y: ${y}`);
      };
    
      canvas.addEventListener('click', handleClick);
    
      drawMap();
      window.addEventListener('resize', drawMap);
      return () => {
        window.removeEventListener('resize', drawMap);
        canvas.removeEventListener('click', handleClick);
      };
    }, [unidades]);

  const handleMark = () => {
    const { manzana, lote } = selected;
    const nuevaPosicion = coordenadasLotes[Number(manzana)]?.[Number(lote)];

    if (nuevaPosicion) {
      setUnidades([...unidades, { id: unidades.length + 1, manzana: Number(manzana), lote: Number(lote), position: nuevaPosicion }]);
    } else {
      alert('Coordenadas no definidas para esta manzana y lote.');
    }
  };

  return (
    <div ref={containerRef} style={{ position: 'relative', width: '100%', height: '500px' }}>
      <h2>Mapa de Unidades Funcionales</h2>
      <canvas ref={canvasRef} style={{ width: '100%', height: '100%' }} />
      <div style={{ marginTop: '10px' }}>
        <input
          type="number"
          placeholder="Manzana"
          value={selected.manzana}
          onChange={(e) => setSelected({ ...selected, manzana: e.target.value })}
        />
        <input
          type="number"
          placeholder="Lote"
          value={selected.lote}
          onChange={(e) => setSelected({ ...selected, lote: e.target.value })}
        />
        <button onClick={handleMark}>Marcar</button>
      </div>
    </div>
  );
};
